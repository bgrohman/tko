/*! tko - v0.2.0 - 2012-12-26
* https://github.com/bgrohman/tko
* Copyright (c) 2012 Bryan Grohman; Licensed MIT */
(function(e,t){"use strict";typeof define=="function"&&define.amd?define(["underscore","knockout","jquery","amplify","routie","bootstrap"],t):e.tko=t(e._,e.ko,e.$,e.amplify,e.routie)})(this,function(e,t,n,r,i){"use strict";function o(){this.urlRoot=null,this.id=null,this.setProperties=function(n){var r=this,i,s,o;!e.isUndefined(n)&&!e.isNull(n)&&(i=t.toJS(n),e.each(e.keys(r),function(n){n!=="id"&&(s=r[n],t.isObservable(s)&&(o=i[n],e.isUndefined(o)||s(o)))}),e.isUndefined(i.id)||e.isNull(r.id)&&(r.id=t.observable(i.id)))},this.toJS=function(){var n=this,r={};return e.each(e.keys(n),function(e){t.isObservable(n[e])&&(r[e]=n[e]())}),r},this.save=function(){var r=this,i,s,o,u;return e.isUndefined(r.id)||e.isNull(r.id)?(o="POST",s=r.urlRoot):(o="PUT",i=t.isObservable(r.id)?r.id():r.id,s=r.urlRoot+"/"+i),u=n.ajax({type:o,url:s,cache:!1,data:r.toJS(),dataType:"json"}),u.done(function(n){e.isUndefined(n.id)||(r.id=t.observable(n.id))}),u},this.destroy=function(){var r=this,i;return e.isUndefined(r.id)?null:(i=t.isObservable(r.id)?r.id():r.id,n.ajax({type:"DELETE",url:r.urlRoot+"/"+i,cache:!1}))},this.fetch=function(){var r=this,i,s;return e.isUndefined(r.id)?null:(s=t.isObservable(r.id)?r.id():r.id,i=n.ajax({type:"GET",url:r.urlRoot+"/"+s,cache:!1}),i.done(function(e){r.setProperties(e)}),i)}}function u(n){var r=this,i=["error","warning","success","info"],s=["<% _.each(types, function(type) { %>",'<div class="alert alert-<%= type %>" data-bind="visible: <%= type %>">','<button type="button" class="close" data-bind="click: function() {clear(\'<%= type %>\');}">&times;</button>','<span data-bind="text: <%= type %>"></span>',"</div>","<% }) %>"].join("");r.template=['<div id="notifications" data-bind="visible: visible">',e.template(s,{types:i}),"</div>"].join(""),e.each(i,function(e){r[e]=t.observable()}),r.clear=function(t){e.has(r,t)&&r[t](null)},r.visible=t.computed(function(){var t=["error","warning","success","info"];return e.any(t,function(t){var n=r[t]();return!(e.isUndefined(n)||e.isNull(n)||e.isEmpty(n))})})}function a(e,n){var r=this;r.isDefault=t.observable(n.isDefault),r.visible=t.observable(!1),r.name=t.observable(n.name),r.route=t.observable(n.route),r.href=t.computed(function(){return"#"+r.route()})}function f(o){function h(){var t=window.location.hash,n,r=!0;e.isEmpty(t)||(n=t.substr(1),e.isEmpty(n)||(f.navigate(""),f.navigate(n),r=!1)),r&&!e.isUndefined(f.defaultPage())&&f.navigate(f.defaultPage().route())}function p(){var r;e.isArray(o.pages)&&(r=n('<div id="pages"></div>'),f.$root.append(r),e.each(o.pages,function(i){var s=new a(f,i),o;e.extend(s,new i.ViewModel(f)),f.pages.push(s),f.route(i.route,function(){e.each(f.pages,function(e,t){e.visible(!1)}),s.visible(!0)}),i.isDefault&&f.defaultPage(s),o=n('<div data-bind="visible: visible">'+s.view+"</div>"),r.append(o),t.applyBindings(s,o[0])}))}function d(){e.isObject(o.routes)&&e.each(o.routes,function(e,t){f.route(t,function(){e.apply(f,arguments)})})}function v(){var e=s.nav,t=n(e);f.$root.prepend(t)}function m(){var e=n(f.notifications.template);f.notifications.$element=e,f.$root.prepend(e)}function g(){e.each(o,function(e,t){t!=="pages"&&t!=="routes"&&(f[t]=e)}),m(),v(),p(),d(),n(function(){t.applyBindings(f,f.$root.find(".navbar")[0]),t.applyBindings(f.notifications,f.$root.find("#notifications")[0]),h(),f.$root.show(),l=!0,f.publish("app.initialized")})}var f=this,l=!1,c={};f.$root=n("#root"),f.defaultPage=t.observable(),f.pages=[],f.navLinks=[],f.notifications=new u(f),f.getPage=function(t){return e.find(f.pages,function(e){return e.name()===t})},f.notify=function(t,n,r){e.has(f.notifications,t)&&(c[t]&&clearTimeout(c[t]),f.notifications[t](n),e.isNumber(r)&&(c[t]=setTimeout(function(){f.notifications.clear(t),c[t]=null},r)))},f.publish=function(e,t){r.publish(e,t)},f.subscribe=function(e,t){if(e!=="app.initialized"||!l)return r.subscribe(e,t);t()},f.unsubscribe=function(e,t){r.unsubscribe(e,t)},f.retrieveSetting=function(e){return r.store(e)},f.saveSetting=function(e,t){return r.store(e,t)},f.route=function(e,t){i(e,t)},f.navigate=function(e){i(e)},g()}var s={nav:['<div class="navbar">','<div class="navbar-inner">',"<!-- ko if: defaultPage -->",'<a class="brand" data-bind="text: defaultPage().name, attr: {href: defaultPage().href}"></a>',"<!-- /ko -->",'<ul class="nav" data-bind="foreach: pages">',"<!-- ko ifnot: isDefault -->",'<li data-bind="if: !isDefault(), css: {active: visible}">','<a data-bind="text: name, attr: {href: href}"></a>',"</li>","<!-- /ko -->","</ul>","</div>","</div>"].join("")};return o.extend=function(n){return function(r){var i=new o;return e.each(n,function(e,n){t.isObservable(e)?i[n]=t.observable(e()):i[n]=e}),i.setProperties(r),i}},{Notifications:u,Model:o,App:f}});