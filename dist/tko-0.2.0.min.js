/*! tko - v0.2.0 - 2013-01-21
* https://github.com/bgrohman/tko
* Copyright (c) 2013 Bryan Grohman; Licensed MIT */
(function(e,t){"use strict";typeof define=="function"&&define.amd?define(["underscore","knockout","jquery","amplify","routie","bootstrap"],t):e.tko=t(e._,e.ko,e.$,e.amplify,e.routie)})(this,function(e,t,n,r,i){"use strict";function o(){var r=this;r.urlRoot=null,r.id=null,r.setProperties=function(n){var i,s,o;!e.isUndefined(n)&&!e.isNull(n)&&(i=t.toJS(n),e.each(e.keys(r),function(n){n!=="id"&&(s=r[n],t.isObservable(s)&&(o=i[n],e.isUndefined(o)||s(o)))}),e.isUndefined(i.id)||e.isNull(r.id)&&(r.id=t.observable(i.id)))},r.toJS=function(){var n={};return e.each(e.keys(r),function(e){t.isObservable(r[e])&&(n[e]=r[e]())}),n},r.save=function(){var i,s,o,u;return e.isUndefined(r.id)||e.isNull(r.id)?(o="POST",s=r.urlRoot):(o="PUT",i=t.isObservable(r.id)?r.id():r.id,s=r.urlRoot+"/"+i),u=n.ajax({type:o,url:s,cache:!1,data:r.toJS(),dataType:"json"}),u.done(function(n){e.isUndefined(n.id)||(r.id=t.observable(n.id))}),u},r.destroy=function(){var i;return e.isUndefined(r.id)?null:(i=t.isObservable(r.id)?r.id():r.id,n.ajax({type:"DELETE",url:r.urlRoot+"/"+i,cache:!1}))},r.fetch=function(){var i,s;return e.isUndefined(r.id)?null:(s=t.isObservable(r.id)?r.id():r.id,i=n.ajax({type:"GET",url:r.urlRoot+"/"+s,cache:!1}),i.done(function(e){r.setProperties(e)}),i)}}function u(){function s(){r.sort()}function o(e){i.dispose(),e.call(r),i=r.values.subscribe(s)}var r=this,i;r.url=null,r.model=null,r.values=t.observableArray([]),i=r.values.subscribe(s),r.sortBy=t.observable(),r.sortBy.subscribe(function(){r.sort()}),r.length=t.computed(function(){return r.values().length}),r.at=function(e){return r.values()[e]},r.get=function(t){return e.find(r.values(),function(e){return e.id&&e.id()===t})},r.toJS=function(){return e.map(r.values(),function(e){return e.toJS()})},r.sort=function(){o(function(){var n=r.sortBy();e.isString(n)?r.values().sort(function(e,r){var i=t.toJS(e[n]),s=t.toJS(r[n]);return i>s?1:-1}):e.isFunction(n)&&r.values().sort(n),r.values.valueHasMutated()})},r.saveAll=function(){var e,t;return t=JSON.stringify(r.toJS()),e=n.ajax({type:"POST",url:r.url,cache:!1,contentType:"application/json; charset=utf-8",processData:!1,data:t}),e},r.fetch=function(){var t=n.ajax({type:"GET",url:r.url,cache:!1});return t.done(function(t){e.each(t,function(e){o(function(){var t=new r.model(e);r.values.push(t)})}),r.sort()}),t}}function a(n){var r=this,i=["error","warning","success","info"],s=["<% _.each(types, function(type) { %>",'<div class="alert alert-<%= type %>" data-bind="visible: <%= type %>">','<button type="button" class="close" data-bind="click: function() {clear(\'<%= type %>\');}">&times;</button>','<span data-bind="text: <%= type %>"></span>',"</div>","<% }) %>"].join("");r.template=['<div id="notifications" data-bind="visible: visible">',e.template(s,{types:i}),"</div>"].join(""),e.each(i,function(e){r[e]=t.observable()}),r.clear=function(t){e.has(r,t)&&r[t](null)},r.visible=t.computed(function(){var t=["error","warning","success","info"];return e.any(t,function(t){var n=r[t]();return!(e.isUndefined(n)||e.isNull(n)||e.isEmpty(n))})})}function f(e,n){var r=this;r.isDefault=t.observable(n.isDefault),r.visible=t.observable(!1),r.name=t.observable(n.name),r.route=t.observable(n.route),r.href=t.computed(function(){return"#"+r.route()})}function l(o){function h(){var t=window.location.hash,n,r=!0;e.isEmpty(t)||(n=t.substr(1),e.isEmpty(n)||(u.navigate(""),u.navigate(n),r=!1)),r&&!e.isUndefined(u.defaultPage())&&u.navigate(u.defaultPage().route())}function p(){var r;e.isArray(o.pages)&&(r=n('<div id="pages"></div>'),u.$root.append(r),e.each(o.pages,function(i){var s=new f(u,i),o;e.extend(s,new i.ViewModel(u)),u.pages.push(s),u.route(i.route,function(){e.each(u.pages,function(e,t){e.visible(!1)}),s.visible(!0)}),i.isDefault&&u.defaultPage(s),o=n('<div data-bind="visible: visible">'+s.view+"</div>"),r.append(o),t.applyBindings(s,o[0])}))}function d(){e.isObject(o.routes)&&e.each(o.routes,function(e,t){u.route(t,function(){e.apply(u,arguments)})})}function v(){var e=s.nav,t=n(e);u.$root.prepend(t)}function m(){var e=n(u.notifications.template);u.notifications.$element=e,u.$root.prepend(e)}function g(){e.each(o,function(e,t){t!=="pages"&&t!=="routes"&&(u[t]=e)}),m(),v(),p(),d(),n(function(){t.applyBindings(u,u.$root.find(".navbar")[0]),t.applyBindings(u.notifications,u.$root.find("#notifications")[0]),h(),u.$root.show(),l=!0,u.publish("app.initialized")})}var u=this,l=!1,c={};u.$root=n("#root"),u.defaultPage=t.observable(),u.pages=[],u.navLinks=[],u.notifications=new a(u),u.getPage=function(t){return e.find(u.pages,function(e){return e.name()===t})},u.notify=function(t,n,r){e.has(u.notifications,t)&&(c[t]&&clearTimeout(c[t]),u.notifications[t](n),e.isNumber(r)&&(c[t]=setTimeout(function(){u.notifications.clear(t),c[t]=null},r)))},u.publish=function(e,t){r.publish(e,t)},u.subscribe=function(e,t){if(e!=="app.initialized"||!l)return r.subscribe(e,t);t()},u.unsubscribe=function(e,t){r.unsubscribe(e,t)},u.retrieveSetting=function(e){return r.store(e)},u.saveSetting=function(e,t){return r.store(e,t)},u.route=function(e,t){i(e,t)},u.navigate=function(e){i(e)},g()}var s={nav:['<div class="navbar">','<div class="navbar-inner">',"<!-- ko if: defaultPage -->",'<a class="brand" data-bind="text: defaultPage().name, attr: {href: defaultPage().href}"></a>',"<!-- /ko -->",'<ul class="nav" data-bind="foreach: pages">',"<!-- ko ifnot: isDefault -->",'<li data-bind="if: !isDefault(), css: {active: visible}">','<a data-bind="text: name, attr: {href: href}"></a>',"</li>","<!-- /ko -->","</ul>","</div>","</div>"].join("")};return o.extend=function(n){return function(r){var i=new o;return e.each(n,function(e,n){t.isObservable(e)?i[n]=t.observable(e()):i[n]=e}),i.setProperties(r),i}},u.extend=function(n){var r=["length"];return function(i){var s=new u;return e.each(e.omit(n,r),function(e,n){t.isObservable(s[n])?s[n](t.isObservable(e)?e():e):s[n]=t.isObservable(e)?e():e}),e.isArray(i)&&s.values(e.map(i,function(t){return t instanceof o?t:s.model?new s.model(t):e.clone(t)})),s}},{Notifications:a,Model:o,Collection:u,App:l}});