/*! tko - v0.3.1 - 2013-03-18
* https://github.com/bgrohman/tko
* Copyright (c) 2013 Bryan Grohman; Licensed MIT */
(function(e,t){"use strict";typeof define=="function"&&define.amd?define(["underscore","knockout","jquery","amplify","routie","bootstrap"],t):e.tko=t(e._,e.ko,e.$,e.amplify,e.routie)})(this,function(e,t,n,r,i){"use strict";function u(t){return e.isFunction(t)&&t.tko&&t.tko.modelConstructor}function a(t){return e.isFunction(t)&&t.tko&&t.tko.collectionConstructor}function f(){function i(e,t,n){e[t]instanceof f?r[t](e[t]):r[t](new n.constructor(e[t]))}function o(e,t,n){e[t]instanceof s.Collection?r[t](e[t]):r[t](new n.constructor(e[t]))}function u(n,i){var s=r[i],o;t.isObservable(s)&&(o=n[i],e.isUndefined(o)||s(o))}var r=this;r.urlRoot=null,r.id=null,r.setProperties=function(n){!e.isUndefined(n)&&!e.isNull(n)&&(e.each(e.keys(r),function(t){var s,a;t!=="id"&&(s=e.find(r._tko_.modelKeys,function(e){return e.key===t}),s?i(n,t,s):(a=e.find(r._tko_.collectionKeys,function(e){return e.key===t}),a?o(n,t,a):u(n,t)))}),e.isUndefined(n.id)||e.isNull(r.id)&&(r.id=t.observable(n.id)))},r.clone=function(){var n=new f,i;return e.each(e.keys(r),function(o){o!=="id"&&(i=r[o],t.isObservable(i)&&(i()instanceof f||i()instanceof s.Collection?n[o]=t.observable(i().clone()):n[o]=t.observable(i())),n._tko_=e.clone(r._tko_))}),n},r.toJS=function(){var n={};return e.each(e.keys(r),function(e){t.isObservable(r[e])&&(r[e]()instanceof f||r[e]()instanceof s.Collection?n[e]=r[e]().toJS():n[e]=r[e]())}),n},r.save=function(){var i,s,o,u;return e.isUndefined(r.id)||e.isNull(r.id)?(o="POST",s=r.urlRoot):(o="PUT",i=t.isObservable(r.id)?r.id():r.id,s=r.urlRoot+"/"+i),u=n.ajax({type:o,url:s,cache:!1,data:r.toJS(),dataType:"json"}),u.done(function(n){e.isUndefined(n.id)||(r.id=t.observable(n.id))}),u},r.destroy=function(){var i;return e.isUndefined(r.id)?null:(i=t.isObservable(r.id)?r.id():r.id,n.ajax({type:"DELETE",url:r.urlRoot+"/"+i,cache:!1}))},r.fetch=function(){var i,s;return e.isUndefined(r.id)?null:(s=t.isObservable(r.id)?r.id():r.id,i=n.ajax({type:"GET",url:r.urlRoot+"/"+s,cache:!1}),i.done(function(e){r.setProperties(e)}),i)}}function l(){function s(){r.sort()}function o(e){i.dispose(),e.call(r),i=r.values.subscribe(s)}var r=this,i;r.url=null,r.model=null,r.values=t.observableArray([]),i=r.values.subscribe(s),r.sortBy=t.observable(),r.sortBy.subscribe(function(){r.sort()}),r.length=t.computed(function(){return r.values().length}),r.at=function(e){return r.values()[e]},r.get=function(t){return e.find(r.values(),function(e){return e.id&&e.id()===t})},r.toJS=function(){return e.map(r.values(),function(e){return e.toJS()})},r.clone=function(){var t=new l,n;return n=e.map(r.values(),function(e){return e instanceof f||e instanceof l?e.clone():e}),t.url=r.url,t.model=r.model,t.sortBy(r.sortBy()),t.values(n),t},r.sort=function(){o(function(){var n=r.sortBy();e.isString(n)?r.values().sort(function(e,r){var i=t.toJS(e[n]),s=t.toJS(r[n]);return i>s?1:-1}):e.isFunction(n)&&r.values().sort(n),r.values.valueHasMutated()})},r.saveAll=function(){var e,t;return t=JSON.stringify(r.toJS()),e=n.ajax({type:"POST",url:r.url,cache:!1,contentType:"application/json; charset=utf-8",processData:!1,data:t}),e},r.fetch=function(){var t=n.ajax({type:"GET",url:r.url,cache:!1});return t.done(function(t){e.each(t,function(e){o(function(){var t=new r.model(e);r.values.push(t)})}),r.sort()}),t}}function c(n){var r=this,i=["error","warning","success","info"],s=["<% _.each(types, function(type) { %>",'<div class="alert alert-<%= type %>" data-bind="visible: <%= type %>">','<button type="button" class="close" data-bind="click: function() {clear(\'<%= type %>\');}">&times;</button>','<span data-bind="text: <%= type %>"></span>',"</div>","<% }) %>"].join("");r.template=['<div id="notifications" data-bind="visible: visible">',e.template(s,{types:i}),"</div>"].join(""),e.each(i,function(e){r[e]=t.observable()}),r.clear=function(t){e.has(r,t)&&r[t](null)},r.visible=t.computed(function(){var t=["error","warning","success","info"];return e.any(t,function(t){var n=r[t]();return!(e.isUndefined(n)||e.isNull(n)||e.isEmpty(n))})})}function h(e,n){var r=this;r.isDefault=t.observable(n.isDefault),r.visible=t.observable(!1),r.name=t.observable(n.name),r.route=t.observable(n.route),r.href=t.computed(function(){return"#"+r.route()})}function p(s){function p(){var t=window.location.hash,n,r=!0;e.isEmpty(t)||(n=t.substr(1),e.isEmpty(n)||(u.navigate(""),u.navigate(n),r=!1)),r&&!e.isUndefined(u.defaultPage())&&u.navigate(u.defaultPage().route())}function d(){var r;e.isArray(s.pages)&&(r=n('<div id="pages"></div>'),l.routingRoot.append(r),e.each(s.pages,function(i){var s=new h(u,i),o;e.extend(s,new i.ViewModel(u)),u.pages.push(s),u.route(i.route,function(){e.each(u.pages,function(e,t){e.visible(!1)}),s.visible(!0)}),i.isDefault&&u.defaultPage(s),o=n('<div data-bind="visible: visible">'+s.view+"</div>"),r.append(o),t.applyBindings(s,o[0])}))}function v(){e.isObject(s.routes)&&e.each(s.routes,function(e,t){u.route(t,function(){e.apply(u,arguments)})})}function m(){var e=o.nav,t=n(e);l.routingRoot.prepend(t)}function g(){var e=n(u.notifications.template);u.notifications.$element=e,l.routingRoot.prepend(e)}function y(){e.each(s,function(e,t){t!=="pages"&&t!=="routes"&&(u[t]=e)}),g(),l.useSimpleNavigation&&m(),d(),v(),n(function(){l.useSimpleNavigation&&t.applyBindings(u,l.routingRoot.find(".navbar")[0]),t.applyBindings(u.notifications,l.routingRoot.find("#notifications")[0]),p(),l.routingRoot.show(),a=!0,u.publish("app.initialized")})}var u=this,a=!1,f={},l=e.defaults(s.tko||{},{useSimpleNavigation:!1,routingRoot:n("#root")});u.defaultPage=t.observable(),u.pages=[],u.navLinks=[],u.notifications=new c(u),u.getPage=function(t){return e.find(u.pages,function(e){return e.name()===t})},u.notify=function(t,n,r){e.has(u.notifications,t)&&(f[t]&&clearTimeout(f[t]),u.notifications[t](n),e.isNumber(r)&&(f[t]=setTimeout(function(){u.notifications.clear(t),f[t]=null},r)))},u.publish=function(e,t){r.publish(e,t)},u.subscribe=function(e,t){if(e!=="app.initialized"||!a)return r.subscribe(e,t);t()},u.unsubscribe=function(e,t){r.unsubscribe(e,t)},u.retrieveSetting=function(e){return r.store(e)},u.saveSetting=function(e,t){return r.store(e,t)},u.route=function(e,t){i(e,t)},u.navigate=function(e){i(e)},y()}var s,o={nav:['<div class="navbar">','<div class="navbar-inner">',"<!-- ko if: defaultPage -->",'<a class="brand" data-bind="text: defaultPage().name, attr: {href: defaultPage().href}"></a>',"<!-- /ko -->",'<ul class="nav" data-bind="foreach: pages">',"<!-- ko ifnot: isDefault -->",'<li data-bind="if: !isDefault(), css: {active: visible}">','<a data-bind="text: name, attr: {href: href}"></a>',"</li>","<!-- /ko -->","</ul>","</div>","</div>"].join("")};return f.extend=function(n){var r=function(r){var i=new f;return i._tko_={modelKeys:[],collectionKeys:[]},e.each(n,function(e,n){t.isObservable(e)?i[n]=t.observable(e()):u(e)?(i[n]=t.observable(),i._tko_.modelKeys.push({key:n,constructor:e})):a(e)?(i[n]=t.observable(),i._tko_.collectionKeys.push({key:n,constructor:e})):i[n]=e}),i.setProperties(r),i};return r.tko={modelConstructor:!0},r},l.extend=function(n){function i(i){var s=new l;return e.each(e.omit(n,r),function(e,n){t.isObservable(s[n])?s[n](t.isObservable(e)?e():e):s[n]=t.isObservable(e)?e():e}),e.isArray(i)&&s.values(e.map(i,function(t){return t instanceof f?t:s.model?new s.model(t):e.clone(t)})),s}var r=["length"];return i.tko={collectionConstructor:!0},i},s={Notifications:c,Model:f,Collection:l,App:p},s});